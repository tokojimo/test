# Raster Tile Pipeline

This guide explains how to turn a styled suitability raster (RGBA GeoTIFF in EPSG:2154) into a performant XYZ tile set ready to be published behind a CDN. The workflow is the same for every layer and is automated by `scripts/prepare_rasters.sh`.

## Prerequisites

Install GDAL 3.2+ with the Python bindings:

```bash
brew install gdal           # macOS
apt-get install gdal-bin    # Debian/Ubuntu
pip install rasterio        # optional for inspection
```

The script uses `gdalwarp`, `gdal_translate`, `gdaladdo`, `gdal2tiles.py` and `gdalinfo`.

## 1. Prepare the rasters

```bash
# Example with the Grenoble boletus suitability map
git clone <repo>
cd <repo>
./scripts/prepare_rasters.sh build boletus_edulis_suitability_styled.tif another_layer.tif
```

What the script does for each input file:

1. **Reprojects** to EPSG:3857 with `gdalwarp`, preserving the alpha channel and using bilinear resampling.
2. **Converts** the intermediate raster to a Cloud Optimized GeoTIFF (`*.cog.tif`) with DEFLATE compression, 512px blocks and autogenerated overviews.
3. **Generates XYZ tiles** (PNG 256px) at zoom levels 6–16 using `gdal2tiles.py --xyz`.
4. **Logs metadata** (WGS84 bounding box, configured min/max zoom, suggested max zoom derived from pixel size, file size) to `<output>/<layer>/metadata.json`.

Outputs are organised as:

```
build/
  boletus_edulis_suitability_styled/
    boletus_edulis_suitability_styled_3857.tif
    boletus_edulis_suitability_styled.cog.tif
    metadata.json
  tiles/
    boletus_edulis_suitability_styled/{z}/{x}/{y}.png
```

The `metadata.json` log can be committed alongside deployment manifests to keep track of coverage and resolution.

## 2. Publish tiles behind a CDN

1. Upload `build/tiles/<layer>/` to object storage (S3, GCS, Scaleway Object Storage, etc.).
2. Expose the bucket via a CDN with a long-lived immutable cache, e.g.:
   * Set `Cache-Control: public, max-age=31536000, immutable`.
   * Enable gzip/brotli for JSON metadata files.
3. The final URL pattern should be:

```
https://cdn.example.com/tiles/<layer>/{z}/{x}/{y}.png
```

Update `VITE_TILE_CDN_BASE_URL` and `src/config/rasterLayers.ts` accordingly.

## 3. Configure the application

1. Set the CDN base URL in `.env`:

   ```bash
   VITE_TILE_CDN_BASE_URL=https://cdn.example.com
   ```

2. Register each layer in `src/config/rasterLayers.ts` using the metadata from step 1. Example entry:

   ```ts
   {
     id: 'boletus_edulis_suitability_styled',
     name: 'Boletus edulis – aptitude',
     tiles: `${baseUrl}/tiles/boletus_edulis_suitability_styled/{z}/{x}/{y}.png`,
     minzoom: 6,
     maxzoom: 16,
     bounds: [
       [5.507812, 44.706649],
       [7.558594, 45.992813],
     ],
   }
   ```

3. The map automatically loads all configured raster layers above the base OSM map with opacity 0.7 and fits the viewport to the combined extent of the rasters.

## 4. Adding a new layer

1. Drop the styled GeoTIFF (EPSG:2154) into the repo.
2. Run `./scripts/prepare_rasters.sh build <new_layer>.tif`.
3. Upload `build/tiles/<new_layer>/` to the CDN.
4. Copy the generated `metadata.json` values into `src/config/rasterLayers.ts`.
5. Redeploy the frontend (only the configuration file changes).

## 5. Troubleshooting

- **Missing alpha** – ensure the source TIFF has an alpha band; `gdalwarp -dstalpha` keeps it.
- **Color banding** – switch to `-co COMPRESS=ZSTD -co NUM_THREADS=ALL_CPUS` in `gdal_translate` if needed.
- **Slow tiles** – verify CDN caching headers and consider enabling HTTP/2 server push or CloudFront Origin Shield.
- **Coverage gaps** – inspect the `metadata.json` bounds and compare to the expected AOI.

With this setup the heavy lifting happens once during preprocessing, keeping runtime tile serving fast and cost-effective.
